"use strict";

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.default = void 0;

var _rxjs = require("rxjs");

var _documentStore = _interopRequireDefault(require("@sanity/document-store"));

var _client = _interopRequireDefault(require("part:@sanity/base/client"));

var _getPairListener = require("./getPairListener");

var _operators = require("rxjs/operators");

function _interopRequireDefault(obj) { return obj && obj.__esModule ? obj : { default: obj }; }

function fetchDocumentSnapshot(id) {
  return _client.default.observable.getDocument(id).pipe((0, _operators.map)(document => ({
    type: 'snapshot',
    document: document
  })));
}

function fetchQuerySnapshot(query, params) {
  return _client.default.observable.fetch(query, params).pipe((0, _operators.map)(documents => ({
    type: 'snapshot',
    documents: documents
  })));
}

var serverConnection = {
  byIdPair(idPair) {
    return (0, _getPairListener.getPairListener)(idPair);
  },

  byId(id) {
    return _client.default.listen('*[_id == $id]', {
      id: id
    }, {
      includeResult: false,
      events: ['welcome', 'mutation', 'reconnect']
    }).pipe((0, _operators.concatMap)(event => {
      return event.type === 'welcome' ? fetchDocumentSnapshot(id) : (0, _rxjs.of)(event);
    }));
  },

  query(query, params) {
    return (0, _rxjs.defer)(() => _client.default.observable.listen(query, params || {}, {
      includeResult: false,
      events: ['welcome', 'mutation', 'reconnect']
    })).pipe((0, _operators.concatMap)(event => {
      return event.type === 'welcome' ? fetchQuerySnapshot(query, params) : (0, _rxjs.of)(event);
    }));
  },

  mutate(mutations) {
    return _client.default.observable.dataRequest('mutate', mutations, {
      visibility: 'async',
      returnDocuments: false
    });
  },

  delete(id) {
    return _client.default.observable.delete(id, {
      visibility: 'async',
      returnDocuments: false
    });
  },

  create(doc) {
    return _client.default.observable.create(doc);
  },

  createIfNotExists(doc) {
    return _client.default.observable.createIfNotExists(doc);
  },

  createOrReplace(doc) {
    return _client.default.observable.createOrReplace(doc);
  }

};

var _default = (0, _documentStore.default)({
  serverConnection
});

exports.default = _default;