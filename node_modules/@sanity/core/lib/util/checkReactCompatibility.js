"use strict";

var path = require('path');

var semver = require('semver');

var resolveFrom = require('resolve-from');

var generateHelpUrl = require('@sanity/generate-help-url');

var supported = {
  react: '^16.2',
  'react-dom': '^16.2'
};
var deprecated = {// add packages to deprecate support for here
};

module.exports = workDir => {
  var manifest = require(path.join(workDir, 'package.json'));

  var dependencies = Object.assign({}, manifest.dependencies, manifest.devDependencies);
  Object.keys(supported).forEach(pkg => {
    if (!dependencies[pkg]) {
      return;
    }

    var manifestPath = resolveFrom.silent(workDir, path.join(pkg, 'package.json'));
    var installed = manifestPath ? require(manifestPath).version : dependencies[pkg].replace(/[\D.]/g, '');

    if (semver.satisfies(installed, deprecated[pkg])) {
      console.warn("[WARN] ".concat(pkg, " ").concat(deprecated[pkg], " is deprecated and will be unsupported in an upcoming release of Sanity. Please upgrade the ").concat(pkg, " package. Read more at ").concat(generateHelpUrl('upgrade-package'), " "));
    }

    if (!semver.satisfies(semver.coerce(installed), supported[pkg])) {
      throw new Error("Sanity currently only supports ".concat(pkg, "@").concat(supported[pkg], ". Installed version: ").concat(installed, "."));
    }
  });
};