"use strict";

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.default = void 0;

var _truncate2 = _interopRequireDefault(require("lodash/truncate"));

var _debounce2 = _interopRequireDefault(require("lodash/debounce"));

var _propTypes = _interopRequireDefault(require("prop-types"));

var _react = _interopRequireDefault(require("react"));

var _format = _interopRequireDefault(require("date-fns/format"));

var _cardStyle = _interopRequireDefault(require("part:@sanity/components/previews/card-style"));

var _elementResizeDetector = _interopRequireDefault(require("element-resize-detector"));

function _interopRequireDefault(obj) { return obj && obj.__esModule ? obj : { default: obj }; }

function _defineProperty(obj, key, value) { if (key in obj) { Object.defineProperty(obj, key, { value: value, enumerable: true, configurable: true, writable: true }); } else { obj[key] = value; } return obj; }

var index = 0;
var svgStyles = {
  position: 'relative',
  width: '100%',
  height: '100%'
};

var fieldProp = _propTypes.default.oneOfType([_propTypes.default.string, _propTypes.default.node, _propTypes.default.func]);

class CardPreview extends _react.default.PureComponent {
  constructor() {
    super(...arguments);

    _defineProperty(this, "index", index++);

    _defineProperty(this, "_elementResizeDetector", (0, _elementResizeDetector.default)({
      strategy: 'scroll'
    }));

    _defineProperty(this, "state", {
      emWidth: 10
    });

    _defineProperty(this, "setDateElement", element => {
      this.dateElement = element;

      if (element) {
        this._elementResizeDetector.listenTo(this.dateElement, this.onResize);
      }
    });

    _defineProperty(this, "onResize", (0, _debounce2.default)(() => {
      var el = this.dateElement;

      if (el) {
        var fontSize = window.getComputedStyle(el, null).getPropertyValue('font-size').split('px')[0];
        var emWidth = el.offsetWidth / fontSize;
        this.setState({
          emWidth: Math.round(emWidth)
        });
      }
    }, 1000 / 60));
  }

  componentWillReceiveProps(nextProps) {
    if (nextProps.isPlaceholder && this.dateElement) {
      this._elementResizeDetector.uninstall(this.dateElement);
    }

    if (!nextProps.isPlaceholder && this.dateElement) {
      this._elementResizeDetector.listenTo(this.dateElement, this.onResize);
    }
  }

  componentWillUnmount() {
    this._elementResizeDetector.uninstall(this.dateElement);
  }

  render() {
    var _this$props = this.props,
        title = _this$props.title,
        subtitle = _this$props.subtitle,
        description = _this$props.description,
        date = _this$props.date,
        media = _this$props.media,
        mediaDimensions = _this$props.mediaDimensions,
        children = _this$props.children,
        isPlaceholder = _this$props.isPlaceholder,
        status = _this$props.status;
    var emWidth = this.state.emWidth;
    var aspect = mediaDimensions.aspect;

    if (isPlaceholder) {
      return _react.default.createElement("div", {
        className: _cardStyle.default.placeholder
      }, _react.default.createElement("div", {
        className: _cardStyle.default.svg,
        style: svgStyles
      }, media && _react.default.createElement("div", {
        className: _cardStyle.default.media
      }, aspect && _react.default.createElement("div", {
        className: _cardStyle.default.mediaPadding,
        style: {
          paddingTop: "".concat(100 / aspect, "%")
        }
      }), _react.default.createElement("div", {
        className: _cardStyle.default.mediaContent
      })), _react.default.createElement("div", {
        className: _cardStyle.default.meta
      }, _react.default.createElement("div", {
        className: _cardStyle.default.heading
      }, _react.default.createElement("div", {
        className: _cardStyle.default.title
      }, "\xA0"), _react.default.createElement("div", {
        className: _cardStyle.default.date
      }, "\xA0")), _react.default.createElement("div", {
        className: _cardStyle.default.subtitle
      }, "\xA0"), _react.default.createElement("div", {
        className: _cardStyle.default.description_1
      }, "\xA0"), _react.default.createElement("div", {
        className: _cardStyle.default.description_2
      }, "\xA0"))));
    }

    return _react.default.createElement("div", {
      className: _cardStyle.default.root
    }, _react.default.createElement("div", {
      className: _cardStyle.default.inner
    }, media && _react.default.createElement("div", {
      className: _cardStyle.default.media
    }, _react.default.createElement("div", {
      className: _cardStyle.default.mediaPadding,
      style: {
        paddingTop: "".concat(100 / aspect, "%")
      }
    }), _react.default.createElement("div", {
      className: aspect ? _cardStyle.default.mediaContent : _cardStyle.default.mediaContentRelative
    }, typeof media === 'function' && media({
      dimensions: mediaDimensions,
      layout: 'default'
    }), typeof media === 'string' && _react.default.createElement("div", {
      className: _cardStyle.default.mediaString
    }, media), _react.default.isValidElement(media) && media)), _react.default.createElement("div", {
      className: _cardStyle.default.meta
    }, date && _react.default.createElement("div", {
      ref: this.setDateElement,
      className: _cardStyle.default.date,
      title: (0, _format.default)(date, 'ddd, MMM Do, YYYY hh:mm A')
    }, emWidth <= 10 && (0, _format.default)(date, 'DD.MM.YY'), emWidth > 10 && emWidth <= 15 && (0, _format.default)(date, 'DD.MM.YY hh:mm A'), emWidth > 15 && (0, _format.default)(date, 'ddd, MMM Do, YYYY hh:mm A')), _react.default.createElement("div", {
      className: _cardStyle.default.heading
    }, _react.default.createElement("h2", {
      className: _cardStyle.default.title
    }, title), status && _react.default.createElement("div", {
      className: _cardStyle.default.status
    }, typeof status === 'function' && status({
      layout: 'default'
    }) || status)), subtitle && _react.default.createElement("h3", {
      className: _cardStyle.default.subtitle
    }, typeof subtitle === 'function' && subtitle({
      layout: 'card'
    }), typeof subtitle === 'object' && subtitle, typeof subtitle === 'string' && (0, _truncate2.default)(subtitle, {
      length: 30,
      separator: /,? +/
    })), description && _react.default.createElement("p", {
      className: _cardStyle.default.description
    }, typeof description === 'function' && description({
      layout: 'card'
    }), typeof description === 'object' && description, typeof description === 'string' && (0, _truncate2.default)(description, {
      length: 100,
      separator: /,? +/
    })), children)));
  }

}

exports.default = CardPreview;

_defineProperty(CardPreview, "propTypes", {
  title: fieldProp,
  subtitle: fieldProp,
  description: fieldProp,
  date: _propTypes.default.instanceOf(Date),
  status: fieldProp,
  media: fieldProp,
  mediaDimensions: _propTypes.default.shape({
    width: _propTypes.default.number,
    height: _propTypes.default.number,
    fit: _propTypes.default.oneOf(['clip', 'crop', 'fill', 'fillmax', 'max', 'scale', 'min']),
    aspect: _propTypes.default.number
  }),
  children: _propTypes.default.node,
  isPlaceholder: _propTypes.default.bool
});

_defineProperty(CardPreview, "defaultProps", {
  title: 'Untitled',
  subtitle: undefined,
  description: undefined,
  date: undefined,
  status: undefined,
  media: undefined,
  isPlaceholder: false,
  children: undefined,
  mediaDimensions: {
    width: 300,
    height: 225,
    aspect: 4 / 3,
    fit: 'crop'
  }
});