"use strict";

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.default = void 0;

var _get2 = _interopRequireDefault(require("lodash/get"));

var _omit3 = _interopRequireDefault(require("lodash/omit"));

var _propTypes = _interopRequireDefault(require("prop-types"));

var _react = _interopRequireWildcard(require("react"));

var _dropdownStyle = _interopRequireDefault(require("part:@sanity/components/buttons/dropdown-style"));

var _default = _interopRequireDefault(require("part:@sanity/components/buttons/default"));

var _angleDownIcon = _interopRequireDefault(require("part:@sanity/base/angle-down-icon"));

var _default2 = require("part:@sanity/components/lists/default");

var _poppable = _interopRequireDefault(require("part:@sanity/components/utilities/poppable"));

var _build = _interopRequireDefault(require("boundless-arrow-key-navigation/build"));

function _interopRequireWildcard(obj) { if (obj && obj.__esModule) { return obj; } else { var newObj = {}; if (obj != null) { for (var key in obj) { if (Object.prototype.hasOwnProperty.call(obj, key)) { var desc = Object.defineProperty && Object.getOwnPropertyDescriptor ? Object.getOwnPropertyDescriptor(obj, key) : {}; if (desc.get || desc.set) { Object.defineProperty(newObj, key, desc); } else { newObj[key] = obj[key]; } } } } newObj.default = obj; return newObj; } }

function _interopRequireDefault(obj) { return obj && obj.__esModule ? obj : { default: obj }; }

function _extends() { _extends = Object.assign || function (target) { for (var i = 1; i < arguments.length; i++) { var source = arguments[i]; for (var key in source) { if (Object.prototype.hasOwnProperty.call(source, key)) { target[key] = source[key]; } } } return target; }; return _extends.apply(this, arguments); }

function _objectWithoutProperties(source, excluded) { if (source == null) return {}; var target = _objectWithoutPropertiesLoose(source, excluded); var key, i; if (Object.getOwnPropertySymbols) { var sourceSymbolKeys = Object.getOwnPropertySymbols(source); for (i = 0; i < sourceSymbolKeys.length; i++) { key = sourceSymbolKeys[i]; if (excluded.indexOf(key) >= 0) continue; if (!Object.prototype.propertyIsEnumerable.call(source, key)) continue; target[key] = source[key]; } } return target; }

function _objectWithoutPropertiesLoose(source, excluded) { if (source == null) return {}; var target = {}; var sourceKeys = Object.keys(source); var key, i; for (i = 0; i < sourceKeys.length; i++) { key = sourceKeys[i]; if (excluded.indexOf(key) >= 0) continue; target[key] = source[key]; } return target; }

function _objectSpread(target) { for (var i = 1; i < arguments.length; i++) { var source = arguments[i] != null ? arguments[i] : {}; var ownKeys = Object.keys(source); if (typeof Object.getOwnPropertySymbols === 'function') { ownKeys = ownKeys.concat(Object.getOwnPropertySymbols(source).filter(function (sym) { return Object.getOwnPropertyDescriptor(source, sym).enumerable; })); } ownKeys.forEach(function (key) { _defineProperty(target, key, source[key]); }); } return target; }

function _defineProperty(obj, key, value) { if (key in obj) { Object.defineProperty(obj, key, { value: value, enumerable: true, configurable: true, writable: true }); } else { obj[key] = value; } return obj; }

var modifiers = {
  preventOverflow: {
    boundariesElement: 'window',
    padding: 16
  },
  customStyle: {
    enabled: true,
    fn: data => {
      data.styles = _objectSpread({}, data.styles, {
        minWidth: "".concat((0, _get2.default)(data, 'offsets.reference.width' || 100), "px")
      });
      return data;
    }
  }
};

class DropDownButton extends _react.default.PureComponent {
  constructor() {
    super(...arguments);

    _defineProperty(this, "firstItemElement", _react.default.createRef());

    _defineProperty(this, "buttonElement", _react.default.createRef());

    _defineProperty(this, "state", {
      menuOpened: false
    });

    _defineProperty(this, "menuHasKeyboardFocus", false);

    _defineProperty(this, "keyboardNavigation", false);

    _defineProperty(this, "handleClose", () => {
      this.setState({
        menuOpened: false
      });
    });

    _defineProperty(this, "setMenuElement", element => {
      this._menuElement = element;
    });

    _defineProperty(this, "handleOnClick", event => {
      this.setState({
        menuOpened: true
      }); // Checks if the onClick comes from pressing the keyboard

      this.keyboardNavigation = event.detail == 0;
    });

    _defineProperty(this, "handleButtonBlur", event => {
      if (this.state.menuOpened && !this.menuHasKeyboardFocus && this.keyboardNavigation) {
        this.handleClose();
      }
    });

    _defineProperty(this, "handleClickOutside", event => {
      if (event && this._rootElement && this._rootElement.contains(event.target)) {
        // Stop the open button from being clicked
        event.stopPropagation();
        this.handleClose();
      } else {
        this.handleClose();
      }

      this.buttonElement.current.focus();
    });

    _defineProperty(this, "handleItemClick", (event, item) => {
      event.stopPropagation();
      this.handleAction(item);
    });

    _defineProperty(this, "handleItemKeyPress", (event, item) => {
      if (event.key === 'Enter') {
        this.handleAction(item);
      }
    });

    _defineProperty(this, "handleAction", item => {
      this.props.onAction(item);
      this.handleClose();
      this.keyboardNavigation = false;
    });

    _defineProperty(this, "handleMenuBlur", event => {
      this.menuHasKeyboardFocus = false;
      this.buttonElement.current.focus();
      this.handleClose();
    });

    _defineProperty(this, "handleButtonKeyDown", event => {
      if (event.key == 'ArrowDown' && this.state.menuOpened) {
        this.menuHasKeyboardFocus = true;
        this.keyboardNavigation = true;
        this.firstItemElement.current.focus();
      }
    });
  }

  render() {
    var _omit2 = (0, _omit3.default)(this.props, 'onAction'),
        items = _omit2.items,
        renderItem = _omit2.renderItem,
        children = _omit2.children,
        kind = _omit2.kind,
        className = _omit2.className,
        placement = _omit2.placement,
        showArrow = _omit2.showArrow,
        rest = _objectWithoutProperties(_omit2, ["items", "renderItem", "children", "kind", "className", "placement", "showArrow"]);

    var menuOpened = this.state.menuOpened;
    var buttonElement = this.buttonElement && this.buttonElement.current && this.buttonElement.current._element;
    return _react.default.createElement(_default.default, _extends({}, rest, {
      className: _dropdownStyle.default.button,
      onClick: this.handleOnClick,
      kind: kind,
      onKeyDown: this.handleButtonKeyDown,
      onBlur: this.handleButtonBlur,
      ref: this.buttonElement
    }), _react.default.createElement("div", {
      className: _dropdownStyle.default.inner
    }, showArrow ? _react.default.createElement("div", {
      className: _dropdownStyle.default.inner
    }, children, _react.default.createElement(_angleDownIcon.default, {
      color: "inherit",
      className: _dropdownStyle.default.arrow
    })) : children, _react.default.createElement(_poppable.default, {
      modifiers: modifiers,
      placement: placement,
      referenceElement: buttonElement,
      onEscape: this.handleClose,
      onClickOutside: this.handleClose,
      referenceClassName: _dropdownStyle.default.outer,
      popperClassName: _dropdownStyle.default.popper,
      positionFixed: true
    }, menuOpened && _react.default.createElement(_react.Fragment, null, _react.default.createElement(_default2.List, {
      className: _dropdownStyle.default.list
    }, _react.default.createElement(_build.default, null, items.map((item, i) => {
      return _react.default.createElement(_default2.Item, {
        key: i,
        className: _dropdownStyle.default.listItem,
        onClick: event => this.handleItemClick(event, item) //eslint-disable-line react/jsx-no-bind
        ,
        onKeyPress: event => this.handleItemKeyPress(event, item) //eslint-disable-line react/jsx-no-bind
        ,
        item: item,
        tabIndex: 0,
        ref: i === 0 && this.firstItemElement
      }, renderItem(item));
    }))), _react.default.createElement("div", {
      tabIndex: 0,
      onFocus: this.handleMenuBlur
    })))));
  }

}

exports.default = DropDownButton;

_defineProperty(DropDownButton, "propTypes", {
  kind: _propTypes.default.oneOf(['default', 'simple']),
  items: _propTypes.default.arrayOf(_propTypes.default.shape({
    title: _propTypes.default.string.isRequired,
    icon: _propTypes.default.func
  })),
  onAction: _propTypes.default.func.isRequired,
  children: _propTypes.default.node,
  inverted: _propTypes.default.bool,
  icon: _propTypes.default.func,
  loading: _propTypes.default.bool,
  ripple: _propTypes.default.bool,
  colored: _propTypes.default.bool,
  color: _propTypes.default.string,
  className: _propTypes.default.string,
  renderItem: _propTypes.default.func,
  placement: _propTypes.default.string,
  showArrow: _propTypes.default.bool
});

_defineProperty(DropDownButton, "defaultProps", {
  renderItem(item) {
    return _react.default.createElement("div", null, item.title);
  },

  showArrow: true,
  placement: 'bottom-start'
});